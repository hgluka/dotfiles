#!/bin/bash
WINDOW_ID_CONKY=/tmp/conky_window_id
WINDOW_ID_PANEL=/tmp/panel_window_id

conky_launch() {
    killall -q conky
    while pgrep -u $UID -x conky >/dev/null; do sleep 1; done
    conky -c ~/.config/conky/conky.conf 2> /tmp/conky_out
    HEX=$(awk '/drawing to created window/ {print $NF}' /tmp/conky_out | tr -d '()' | awk -Fx '{print $2}')
    mapw -u '0x'"$HEX"
    echo '0x'$HEX > $WINDOW_ID_CONKY
}

launch() {
    conky_launch
    killall -q polybar
    while pgrep -u $UID -x polybar >/dev/null; do sleep 1; done
    polybar panel &
    BAR_ID=$!
    rm -f /tmp/polybar_mqueue_panel
    ln -s /tmp/polybar_mqueue.$BAR_ID /tmp/polybar_mqueue_panel
    sleep 0.23
    echo "cmd:hide" >> /tmp/polybar_mqueue_panel
    polybar top &
    BAR_ID=$!
    rm -f /tmp/polybar_mqueue_top
    ln -s /tmp/polybar_mqueue.$BAR_ID /tmp/polybar_mqueue_top
}

options_open() {
    echo "hook:module/option_menu1" >> /tmp/polybar_mqueue_top
    echo "cmd:show" >> /tmp/polybar_mqueue_panel
    echo "open" > /tmp/polybar_side_panel_state
    CONKY_ID=$(cat $WINDOW_ID_CONKY)
    PANEL_NAME=$(polybar -w panel)
    PANEL_ID=$(xwininfo -name $PANEL_NAME | awk '/Window id:/ {print $4}')
    mapw -m $CONKY_ID
    chwso -r $CONKY_ID
    chwso -r $PANEL_ID
}

options_close() {
    CONKY_ID=$(cat $WINDOW_ID_CONKY)
    mapw -u $CONKY_ID
    echo "hook:module/option_menu1" >> /tmp/polybar_mqueue_top
    echo "cmd:hide" >> /tmp/polybar_mqueue_panel
    echo "close" > /tmp/polybar_side_panel_state
}

options_toggle() {
    if [ "$(cat /tmp/polybar_side_panel_state)" == "open" ]; then
        options_close
    else
        options_open
    fi
}

options_icon() {
    COLOR_NORMAL="%{F$(xrdb -query | awk '/^*.foreground/ {print $2}')}"
    COLOR_ACTIVE="%{F$(xrdb -query | awk '/^*.color3/ {print $2}')}"
    COLOR_END="%{F-}"

    if [ "$(cat /tmp/polybar_side_panel_state)" == "open" ]; then
        echo " $COLOR_ACTIVE$COLOR_END "
    else
        echo " $COLOR_NORMAL$COLOR_END "
    fi
}

case "$1" in
    options)
        options_toggle;;
    options_icon)
        options_icon;; 
    launch)
        launch;;
esac
