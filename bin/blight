#!/bin/bash

RED_GAMMA=$(xgamma 2>&1 | awk '{print substr($3, 1, length($3)-1)}')

lower_brightness() {
    for i in $(seq 10)
    do
        echo $(( 2180 - $i*(2180 - 1180)/10 )) | tee /sys/class/backlight/intel_backlight/brightness >/dev/null
        sleep 0.1
    done
}

raise_brightness() {
    for i in $(seq 10)
    do
        echo $(( 1180 + $i*(2180 - 1180)/10 )) | tee /sys/class/backlight/intel_backlight/brightness >/dev/null
        sleep 0.1
    done
}

toggle_blight() {
    if [ $RED_GAMMA = '1.000' ]; then
        lower_brightness
        xgamma -q -rgamma 1.1 -ggamma 0.8 -bgamma 0.7
        polybar-msg hook blight 1
    else
        xgamma -q -gamma 1
        raise_brightness
        polybar-msg hook blight 1
    fi
}

toggle_icon() {
    COLOR_NORMAL="%{F$(xrdb -query | awk '/^*.foreground/ {print $2}')}"
    COLOR_ACTIVE="%{F$(xrdb -query | awk '/^*.color3/ {print $2}')}"
    COLOR_END="%{F-}"

    if [ $RED_GAMMA = '1.000' ]; then
        echo " $COLOR_NORMAL$COLOR_END "
    else
        echo " $COLOR_ACTIVE$COLOR_END "
    fi
}

case "$1" in
    icon)
        toggle_icon;;
    toggle)
        toggle_blight;;
esac
